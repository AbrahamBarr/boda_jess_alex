<!DOCTYPE html>
<html>
<head>
    <title>Invitación de Boda</title>
<style>
    @font-face {
        font-family: 'Amsterdam Four';
        src: url('/static/fonts/Amsterdam.otf') format('opentype');
        font-weight: normal;
        font-style: normal;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        text-align: center;
        /* background-image: url('/static/invitacion.png'); 
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        min-height: 100vh;
        width: 100%; */
    }

    .svg-container{
        position: relative;
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
    }
        
    .svg-container::before{
        content: "";
        display: block;
        padding-top: 170%;
    }

    .formulario {
        margin-top: 30px;
        padding: 20px;
        background-color: #1c1c1c;
        color: white;
        display: inline-block;
        border-radius: 10px;
    }

    .invite-bg{
        position: absolute; inset: 0;
        background: url("/static/invitacion.png") center/contain no-repeat;
        z-index: 0;
        pointer-events:none;
    }

    #contador{
        position:absolute;
        left:50%;
        top:27%;     
        transform:translateX(-50%) scaleY(.80);
        font-size:2.3rem;
        color:#f9f9f9;
        font-family:'Amsterdam Four', cursive;
        white-space:nowrap;
        text-shadow: 0 0 .5px rgba(0,0,0,.1);
        z-index:1;
    }

    .formulario-flotante{
        position:absolute;
        left:50%;
        top:51%;          
        transform:translateX(-50%);
        width:min(420px, 88%);
        background:transparent;
        z-index:1;
    }

    select {
        background-color: transparent;
        color: white;
        border: 1px solid white;
        border-radius: 5px;
        padding: 8px;
        font-size: 1rem;
        appearance: none; 
    }

    .formulario-flotante label {
        margin-bottom: 10px;
        display: block;
        border: none;
        border-top: none;
        text-decoration: none;
        background: transparent;
        color:#fff;
    }

    .formulario-flotante form {
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
    }
    .formulario-flotante input{
        color:#fff;                        
        background: rgba(0,0,0,.25);       
        border: 1px solid rgba(255,255,255,.6);
        border-radius: 6px;
        padding:10px 12px;

    }

    .formulario-flotante input::placeholder{
        color: rgba(255,255,255,.85);
    }

    .formulario-flotante button{
        background: rgba(255,255,255,.9);
        color:#111;
        border: none;
        border-radius: 6px;
        padding:9px 10px;
        cursor:pointer;
    }
    .sugerencias {
        list-style: none;
        padding: 0;
        margin: 5px 0 0;
        background-color: #fff;
        color: #000;
        border: 1px solid #ccc;
        max-height: 150px;
        overflow-y: auto;
        position: absolute;
        width: 100%;
        z-index: 10;
    }
    .sugerencias li {
        padding: 8px;
        cursor: pointer;
    }

    .sugerencias li:hover {
        background-color: #eee;
    }

    @media (max-width: 480px){
        #contador{ top:27.5%; font-size:1.6rem; }
        .formulario-flotante{ top:54%; width:90%; }
    }

    .boton-calendario {
        display: inline-block;
        padding: 8px 14px;
        background-color: #d4af37; /* dorado */
        color: black;
        border-radius: 6px;
        font-size: 14px;
        text-decoration: none;
    }
    .boton-calendario:hover {
        background-color: #b9982f;
    }

    .boton-calendario-fixed{
        position:absolute;
        left:21%;      
        bottom:2.5%;     
        display:inline-block;
        padding:8px 12px;
        background-color:transparent;
        color:#fff;
        border-radius:6px;
        font-size:14px;
        text-decoration:none;
        z-index:1;   
    }
    .boton-calendario-fixed:hover{ background-color:transparent; }

    @media (max-width:480px){
    .boton-calendario-fixed{
        left:10%;
        bottom:1.5%;
        font-size:13px;
        padding:7px 10px;
    }
    }


</style>

</head>
<body>

<div class="svg-container">
  <div class="invite-bg"></div>

  <div id="contador">Faltan 0 días</div>

    <div class="formulario-flotante">
        <form action="/confirmar" method="post">
            <label for="nombre">Nombre:</label>
            <input type="text" name="nombre" id="nombre" autocomplete="off" required aria-label="Buscar nombre o familia" placeholder="Escriba su nombre o apellido">
            <ul id="sugerencias" class="sugerencias" hidden role="listbox" aria-label="Sugerencias de nombre"></ul>
                <!-- {% for g in nombres_grupo %}
                  <option value="{{ g }}"></option>
                {% endfor %}
            </datalist> -->

            <label for="asistentes">¿Cuántos asistirán? </label>
            <input type="number" name="asistentes" id="asistentes" min="0" required>
            <!--<small style="color:#ccc; font-size:.85rem;">En caso de no asistir, escribe 0</small> -->
            
            <div id="hint-max" style="font-size:.9rem; opacity:.8; margin-top:4px; color:#fff;"></div>

            {% if error %}
                <div style="color:#b00020; margin-top:10px;">{{ error }}</div>
            {% endif %}

            <button type="submit">Confirmar</button>
        </form>
    </div>

    <a 
        href="/static/boda_jessica_alejandro.ics" 
        download="boda_jessica_alejandro.ics"
        class="boton-calendario-fixed"
    >
        📅 Agregar al Calendario
    </a>

</div>



<script>
  const base = new Date("{{ event_date }}"); // ej. 2025-11-15 (local)
  base.setHours(18, 0, 0, 0);                // 18:00:00
  const fechaEvento = base.getTime();        // <-- en vez de "...T00:00:00"
  const contador = document.getElementById("contador");

  setInterval(() => {
    const restante = fechaEvento - Date.now();
    const dias = Math.floor(restante / (1000*60*60*24));
    const horas = Math.floor((restante % (1000*60*60*24)) / (1000*60*60));
    const minutos = Math.floor((restante % (1000*60*60)) / (1000*60));
    const segundos = Math.floor((restante % (1000*60)) / 1000);
    contador.textContent = `Faltan ${dias} días, ${horas} horas ${minutos} minutos ${segundos} segundos`;
  }, 1000);
</script>


<script>
  // === Lógica para aplicar límite según Excel (robusta) ===
  const limites = {{ limites_json|tojson|safe if limites_json is defined else '{}' }};
  const nombreInput = document.getElementById('nombre');
  const asistentesInput = document.getElementById('asistentes');
  const hint = document.getElementById('hint-max');

  // Normaliza por si hay espacios/acentos accidentales
  function norm(s){
    return (s||'')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/\bfam\.?\b/g, 'familia')
      .replace(/[^\p{L}\p{N}\s]/gu, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function getMax(nombre) {
    const q = norm(nombre);
    if (!q) return 0;

    // match exacto por normalización
    let key = Object.keys(limites).find(k => norm(k) === q);
    // fallback: contiene (por si hubo mínima variación)
    if (!key) key = Object.keys(limites).find(k => norm(k).includes(q));

    const raw = key ? limites[key] : 0;
    const n = parseInt(raw, 10);
    return Number.isFinite(n) ? n : 0;
  }

  function aplicarLimite() {
    const nombre = (nombreInput?.value || '').trim();
    const max = getMax(nombre);

    if (asistentesInput) {
      // 🚫 NO pongas max=0; deja libre hasta que haya match
      if (max > 0) {
        asistentesInput.setAttribute('max', max);
        // corrige si ya se pasó
        const val = parseInt(asistentesInput.value || '0', 10);
        if (!Number.isNaN(val) && val > max) asistentesInput.value = max;
        // si está vacío, sugiere 1
        if (!asistentesInput.value) asistentesInput.value = 1;
      } else {
        asistentesInput.removeAttribute('max');
      }
    }

    if (hint) {
      hint.textContent = (max > 0 && nombre)
        ? `${nombre}, hemos reservado ${max} lugar(es) en su honor.`
        : (nombre ? `Verifique el nombre tal como se le indicó por mensaje.` : '');
    }
  }

  nombreInput?.addEventListener('change', aplicarLimite);
  nombreInput?.addEventListener('input', aplicarLimite);
  nombreInput?.addEventListener('blur', aplicarLimite);
  asistentesInput?.addEventListener('input', aplicarLimite);

  {% if nombre_valor %} if (nombreInput) nombreInput.value = {{ nombre_valor|tojson|safe }}; {% endif %}
  {% if asistentes_valor %} if (asistentesInput) asistentesInput.value = {{ asistentes_valor }}; {% endif %}
  aplicarLimite();
</script>


<script>
// Debounce para no saturar el servidor
function debounce(fn, ms){ let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }

async function pedirSugerencias(q){
  const r = await fetch('/api/sugerencias?q=' + encodeURIComponent(q));
  const { sugerencias } = await r.json();
  return Array.isArray(sugerencias) ? sugerencias : [];
}

function renderListaSugerencias(lista){
  const ul = document.getElementById('sugerencias');
  ul.innerHTML = '';
  if (!lista.length){ ul.hidden = true; return; }

  lista.forEach(nombre => {
    const li = document.createElement('li');
    li.textContent = nombre;
    li.addEventListener('mousedown', (e) => {
      e.preventDefault();
      nombreInput.value = nombre;
      ul.hidden = true;
      if (typeof aplicarLimite === 'function') aplicarLimite();
    });
    ul.appendChild(li);
  });
  ul.hidden = false;
}

nombreInput.addEventListener('input', debounce(async () => {
  const q = nombreInput.value || '';
  if (q.trim().length < 2) { document.getElementById('sugerencias').hidden = true; return; }
  const lista = await pedirSugerencias(q);
  renderListaSugerencias(lista);
}, 120));

document.addEventListener('click', (e) => {
  const ul = document.getElementById('sugerencias');
  if (!ul.contains(e.target) && e.target !== nombreInput) ul.hidden = true;
});
</script>

</body>
</html>
