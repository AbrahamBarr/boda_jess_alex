<!DOCTYPE html>
<html>
<head>
    <title>Invitación de Boda</title>
<style>
    @font-face {
        font-family: 'Amsterdam Four';
        src: url('/static/fonts/Amsterdam.otf') format('opentype');
        font-weight: normal;
        font-style: normal;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        text-align: center;
        /* background-image: url('/static/invitacion.png'); 
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        min-height: 100vh;
        width: 100%; */
    }

    .svg-container{
        position: relative;
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
    }
        
    .svg-container::before{
        content: "";
        display: block;
        padding-top: 170%;
    }

    .formulario {
        margin-top: 30px;
        padding: 20px;
        background-color: #1c1c1c;
        color: white;
        display: inline-block;
        border-radius: 10px;
    }

    .invite-bg{
        position: absolute; inset: 0;
        background: url("/static/invitacion.png") center/contain no-repeat;
        z-index: 0;
        pointer-events:none;
    }

    #contador{
        position:absolute;
        left:50%;
        top:27%;     
        transform:translateX(-50%) scaleY(.80);
        font-size:2.3rem;
        color:#f9f9f9;
        font-family:'Amsterdam Four', cursive;
        white-space:nowrap;
        text-shadow: 0 0 .5px rgba(0,0,0,.1);
        z-index:1;
    }

    .formulario-flotante{
        position:absolute;
        left:50%;
        top:51%;          
        transform:translateX(-50%);
        width:min(420px, 88%);
        background:transparent;
        z-index:1;
    }

    select {
        background-color: transparent;
        color: white;
        border: 1px solid white;
        border-radius: 5px;
        padding: 8px;
        font-size: 1rem;
        appearance: none; 
    }

    .formulario-flotante label {
        margin-bottom: 10px;
        display: block;
        border: none;
        border-top: none;
        text-decoration: none;
        background: transparent;
        color:#fff;
    }

    .formulario-flotante form {
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
    }
    .formulario-flotante input{
        color:#fff;                        
        background: rgba(0,0,0,.25);       
        border: 1px solid rgba(255,255,255,.6);
        border-radius: 6px;
        padding:10px 12px;

    }

    .formulario-flotante input::placeholder{
        color: rgba(255,255,255,.85);
    }

    .formulario-flotante button{
        background: rgba(255,255,255,.9);
        color:#111;
        border: none;
        border-radius: 6px;
        padding:9px 10px;
        cursor:pointer;
    }
    .sugerencias {
        list-style: none;
        padding: 0;
        margin: 5px 0 0;
        background-color: #fff;
        color: #000;
        border: 1px solid #ccc;
        max-height: 150px;
        overflow-y: auto;
        position: absolute;
        width: 100%;
        z-index: 10;
    }
    .sugerencias li {
        padding: 8px;
        cursor: pointer;
    }

    .sugerencias li:hover {
        background-color: #eee;
    }

   @media (max-width: 480px){
        #contador{ top:27.5%; font-size:1.6rem; }
        .formulario-flotante{ top:54%; width:90%; }
    }

</style>

</head>
<body>

<div class="svg-container">
  <div class="invite-bg"></div>

  <div id="contador">Faltan 0 días</div>

    <div class="formulario-flotante">
        <form action="/confirmar" method="post">
            <label for="nombre">Nombre:</label>
            <input type="text" name="nombre" id="nombre" autocomplete="off" required aria-label="Buscar nombre o familia" placeholder="Escriba su nombre o apellido">
            <ul id="sugerencias" class="sugerencias" hidden></ul>
                <!-- {% for g in nombres_grupo %}
                  <option value="{{ g }}"></option>
                {% endfor %}
            </datalist> -->

            <label for="asistentes">¿Cuántos asistirán? (En caso de no asistir, escribe 0)</label>
            <input type="number" name="asistentes" id="asistentes" min="1" required>
            <div id="hint-max" style="font-size:.9rem; opacity:.8; margin-top:4px; color:#fff;"></div>

            {% if error %}
                <div style="color:#b00020; margin-top:10px;">{{ error }}</div>
            {% endif %}

            <button type="submit">Confirmar</button>
        </form>
    </div>
</div>

<script>
    // === Contador regresivo ===
    const fechaEvento = new Date("{{ event_date }}T00:00:00").getTime();
    const contador = document.getElementById("contador");

    setInterval(() => {
        const ahora = new Date().getTime();
        const restante = fechaEvento - ahora;

        const dias = Math.floor(restante / (1000 * 60 * 60 * 24));
        const horas = Math.floor((restante % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutos = Math.floor((restante % (1000 * 60 * 60)) / (1000 * 60));
        const segundos = Math.floor((restante % (1000 * 60)) / 1000);

        contador.innerHTML = `Faltan ${dias} días, ${horas} horas ${minutos} minutos ${segundos} segundos`;
    }, 1000);
</script>

<script>
    // === Lógica para aplicar límite según Excel ===
    const limites = {{ limites_json|safe }};
    const nombreInput = document.getElementById('nombre');
    const asistentesInput = document.getElementById('asistentes');
    const hint = document.getElementById('hint-max');

    function getMax(nombre) {
        return Number.isFinite(limites[nombre]) ? parseInt(limites[nombre], 10) : 0;
    }

    function aplicarLimite() {
        const nombre = (nombreInput?.value || '').trim();
        const max = getMax(nombre);

        if (asistentesInput) {
            asistentesInput.setAttribute('max', max);
            const val = parseInt(asistentesInput.value || '0', 10);
            if (!Number.isNaN(val) && val > max) {
                asistentesInput.value = max;
            }
        }
        if (hint) {
            hint.textContent = max > 0
                ? `${nombre}, hemos reservado ${max} lugares en su honor.`
                : (nombre ? `Verifique el nombre tal como se le indico por mensaje.` : '');
        }
    }

    nombreInput?.addEventListener('change', aplicarLimite);
    nombreInput?.addEventListener('input', aplicarLimite);
    nombreInput?.addEventListener('blur', aplicarLimite);
    asistentesInput?.addEventListener('input', aplicarLimite);

    {% if nombre_valor %} if (nombreInput) nombreInput.value = {{ nombre_valor|tojson }}; {% endif %}
    {% if asistentes_valor %} if (asistentesInput) asistentesInput.value = {{ asistentes_valor }}; {% endif %}

    aplicarLimite();
</script>

<script>
  // Nombres desde el backend
  const nombres = {{ nombres_grupo | tojson }};
  const sugerencias = document.getElementById('sugerencias');

  function renderSugerencias(query){
    sugerencias.innerHTML = '';
    if (!query) { sugerencias.hidden = true; return; }

    const q = query.toLowerCase();
    // Muestra solo primeras 12 coincidencias
    const hits = nombres.filter(n => n.toLowerCase().includes(q)).slice(0, 12);

    if (hits.length === 0) { sugerencias.hidden = true; return; }

    hits.forEach(nombre => {
      const li = document.createElement('li');
      li.textContent = nombre;
      // Usamos mousedown para que no se pierda el foco del input antes del click
      li.addEventListener('mousedown', (e) => {
        e.preventDefault();
        nombreInput.value = nombre;
        sugerencias.hidden = true;
        aplicarLimite(); // aplica el máximo al campo asistentes
      });
      sugerencias.appendChild(li);
    });
    sugerencias.hidden = false;
  }

  // Mostrar solo al escribir
  nombreInput.addEventListener('input', () => renderSugerencias(nombreInput.value));

  // Ocultar al hacer click fuera
  document.addEventListener('click', (e) => {
    if (!sugerencias.contains(e.target) && e.target !== nombreInput) {
      sugerencias.hidden = true;
    }
  });

  // Ocultar al perder foco (un pequeño delay por si se hace click en una sugerencia)
  nombreInput.addEventListener('blur', () => setTimeout(() => (sugerencias.hidden = true), 100));
</script>


</body>
</html>
